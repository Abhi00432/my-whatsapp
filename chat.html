<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <style>
    body {
      margin: 0;
      font-family: Arial;
      display: flex;
      height: 100vh;
      background: #ece5dd
    }

    #users {
      width: 30%;
      background: #075e54;
      color: #fff;
      overflow: auto
    }

    .user {
      padding: 10px;
      cursor: pointer;
      display: flex;
      align-items: center
    }

    .user img {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      margin-right: 10px
    }

    #chat {
      flex: 1;
      display: flex;
      flex-direction: column
    }

    #header {
      background: #128c7e;
      color: #fff;
      padding: 10px;
      display: flex;
      align-items: center
    }

    #header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px
    }

    #msgs {
      flex: 1;
      padding: 10px;
      overflow: auto
    }

    .me {
      text-align: right;
      margin: 6px
    }

    .me span {
      background: #dcf8c6;
      padding: 8px 12px;
      border-radius: 8px;
      display: inline-block
    }

    .other {
      text-align: left;
      margin: 6px
    }

    .other span {
      background: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      display: inline-block
    }

    #typing {
      font-size: 12px;
      color: #555;
      padding-left: 10px;
      display: none
    }

    #input {
      display: flex;
      align-items: center;
      padding: 8px;
      background: #fff
    }

    #input input {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc
    }

    #input button {
      margin-left: 5px;
      padding: 10px;
      border: none;
      border-radius: 50%;
      background: #128c7e;
      color: #fff
    }

    #audioBtn {
      background: #25D366
    }
  </style>
</head>

<body>

  <div id="users"></div>

  <div id="chat">
    <div id="header">
      <img id="chatDp">
      <div>
        <div id="chatName">Select user</div>
        <small id="status">offline</small>
      </div>
      <button onclick="startCall()">üìû</button>
      <button onclick="endCall()">‚ùå</button>
    </div>

    <div id="msgs"></div>
    <div id="typing">typing...</div>

    <div id="input">
      <input id="msgInput" placeholder="Type message">
      <button id="audioBtn">üé§</button>
      <button onclick="send()">‚û§</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const me = JSON.parse(localStorage.user);
    const socket = io();
    let to = null, rec, recording = false, pc, localStream;

    chatDp.src = me.dp;
    chatName.innerText = me.name;
    socket.emit("register", me._id);

    /* users */
    fetch("/users").then(r => r.json()).then(list => {
      users.innerHTML = list.filter(u => u._id !== me._id).map(u => `
    <div class="user" onclick="openChat('${u._id}','${u.name}','${u.dp}',${u.online})">
      <img src="${u.dp}">${u.name}
    </div>`).join("");
    });

    socket.on("presence", d => {
      if (d.userId === to) status.innerText = d.online ? "online" : "offline";
    });

    function openChat(id, n, d, o) {
      to = id; chatName.innerText = n; chatDp.src = d;
      status.innerText = o ? "online" : "offline";
      msgs.innerHTML = "";
    }

    /* text */
    function send() {
      if (!to || !msgInput.value.trim()) return;
      socket.emit("msg", { from: me._id, to, text: msgInput.value });
      msgs.innerHTML += `<div class="me"><span>${msgInput.value}</span></div>`;
      msgInput.value = "";
    }

    /* typing */
    msgInput.onkeydown = e => {
      if (e.key === "Enter") { e.preventDefault(); send(); }
      else socket.emit("typing", { to, from: me._id });
    };
    socket.on("typing", d => { if (d.from === to) typing.style.display = "block" });
    socket.on("stopTyping", d => { if (d.from === to) typing.style.display = "none" });

    /* receive */
    socket.on("msg", d => {
      if (d.from === to) {
        msgs.innerHTML += `<div class="other"><span>${d.text}</span></div>`;
        typing.style.display = "none";
      }
    });

    /* voice message */
    audioBtn.onmousedown = startRec;
    audioBtn.onmouseup = stopRec;

    async function startRec() {
      if (!to || recording) return;
      recording = true;
      const s = await navigator.mediaDevices.getUserMedia({ audio: true });
      rec = new MediaRecorder(s);
      const c = [];
      rec.ondataavailable = e => c.push(e.data);
      rec.onstop = async () => {
        const b = new Blob(c, { type: "audio/webm" });
        const f = new FormData(); f.append("audio", b);
        const r = await fetch("/voice", { method: "POST", body: f });
        const j = await r.json();
        socket.emit("voice", { from: me._id, to, url: j.url });
        msgs.innerHTML += `<div class="me"><audio controls src="${j.url}"></audio></div>`;
      };
      rec.start();
    }
    function stopRec() { if (rec) { recording = false; rec.stop(); } }
    socket.on("voice", d => {
      if (d.from === to) msgs.innerHTML += `<div class="other"><audio controls src="${d.url}"></audio></div>`;
    });

    /* CALL */
    const cfg = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    async function startCall() {
      if (!to) return;
      pc = new RTCPeerConnection(cfg);
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      pc.onicecandidate = e => e.candidate && socket.emit("call-ice", { to, from: me._id, c: e.candidate });
      pc.ontrack = e => {
        const a = document.createElement("audio");
        a.srcObject = e.streams[0]; a.autoplay = true;
        msgs.appendChild(a);
      };
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("call-offer", { to, from: me._id, sdp: offer });
    }
    socket.on("call-offer", async d => {
      if (d.from !== to) return;
      pc = new RTCPeerConnection(cfg);
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      pc.onicecandidate = e => e.candidate && socket.emit("call-ice", { to: d.from, from: me._id, c: e.candidate });
      pc.ontrack = e => {
        const a = document.createElement("audio");
        a.srcObject = e.streams[0]; a.autoplay = true;
        msgs.appendChild(a);
      };
      await pc.setRemoteDescription(d.sdp);
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      socket.emit("call-answer", { to: d.from, from: me._id, sdp: ans });
    });
    socket.on("call-answer", d => pc && pc.setRemoteDescription(d.sdp));
    socket.on("call-ice", d => pc && pc.addIceCandidate(d.c));
    function endCall() {
      if (pc) { pc.close(); pc = null; }
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      socket.emit("call-end", { to, from: me._id });
    }
  </script>

</body>

</html>